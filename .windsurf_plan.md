# Project Plan: simple-social-thing

## Current Goals
- Ensure Google OAuth works locally and in production (Cloudflare Workers).
- Run Vite (client) and Wrangler (worker) together via a single dev command.
- Avoid local port conflicts from the Cloudflare Vite plugin/Miniflare.

## Decisions
- Worker OAuth callback path: `/api/auth/google/callback`.
- Build `redirect_uri` dynamically in the Worker from `request.url.origin` to avoid hardcoding ports/domains.
- Frontend builds `redirect_uri` using `VITE_WORKER_ORIGIN` with fallback to `window.location.origin`.
- Use Google v2 authorize endpoint: `https://accounts.google.com/o/oauth2/v2/auth`.
- Disable `@cloudflare/vite-plugin` during `vite dev` to avoid Miniflare using port 9229; still allow enabling via env.

## Local Development
- Env file (`frontend/.env.local`):
  - `VITE_WORKER_ORIGIN=http://localhost:18912`
  - `VITE_DISABLE_CF_PLUGIN=1`
  - `VITE_GOOGLE_CLIENT_ID=<your-client-id>`
- Start dev servers: `npm run dev` from `frontend/`.
  - Client: http://localhost:18910
  - Worker: http://localhost:18912
- Authorized redirect URI in Google Console (dev):
  - `http://localhost:18912/api/auth/google/callback`

### Hyperdrive (dev)
- Create Hyperdrive resource: `wrangler hyperdrive create sst-db --connection-string "$DATABASE_URL"` (prints an `id`).
- Bind in `frontend/wrangler.jsonc`:
  - `"hyperdrive": [{ "binding": "HYPERDRIVE", "id": "<id>" }]`
- Start dev with local connection string:
  - `export DATABASE_URL="postgresql://…?sslmode=require"`
  - `CLOUDFLARE_HYPERDRIVE_LOCAL_CONNECTION_STRING_HYPERDRIVE="$DATABASE_URL" npm run dev`

## Production (Cloudflare)
- Set Worker secrets:
  - `wrangler secret put GOOGLE_CLIENT_ID`
  - `wrangler secret put GOOGLE_CLIENT_SECRET`
- Authorized redirect URI in Google Console (prod):
  - `https://<your-worker-domain>/api/auth/google/callback` (e.g., workers.dev or custom domain via routes)
- Frontend config:
  - If same origin as Worker, omit `VITE_WORKER_ORIGIN` (fallback to `window.location.origin`).
  - If different origin, set `VITE_WORKER_ORIGIN=https://<your-worker-domain>`.
- Deploy: `npm run deploy` from `frontend/`.

## Next Up
- Add basic auth state handling in the client after redirect parameter `?oauth=...`.
- Add error handling UI for OAuth failures.
- Wire up API calls behind `/api/` in Worker.

### Suno Integration
- API key storage is proxied through the Worker to the Go backend.
- Worker handles backend outages gracefully:
  - `GET /api/integrations/suno/api-key` returns `ok=false, error=backend_unreachable` (502) on network failure; `ok=false, error=backend_error` (502) on non-OK backend.
  - `PUT /api/integrations/suno/api-key` returns `ok=false, error=backend_unreachable` (502) on network failure.
  - Local dev: if no `sid` cookie, Worker issues one and attempts to create a placeholder user in the backend.

## Database Integration (Postgres via Hyperdrive)
- **Decision (updated)**: Use Cloudflare Hyperdrive + `postgres` client directly from the Worker (no REST), writing to Xata's Postgres endpoint.
- **Local dev**: Keep Hyperdrive binding by `id` in `frontend/wrangler.jsonc`; for local, pass a real Postgres URL via env var `CLOUDFLARE_HYPERDRIVE_LOCAL_CONNECTION_STRING_HYPERDRIVE` or add a literal `localConnectionString`.
- **Prod**: Use Hyperdrive resource `id` only; Cloudflare provides the connection string.
- **Users table**: Persist `id`, `email`, `name`, `imageUrl` into `public."Users"`.
  - Upsert behavior: update by `email` first (returns canonical `id`), else insert by Google `id`.
- **SocialConnections**: Persist links into `public."SocialConnections"` with fields `id`, `userId`, `provider`, `providerId`, `email`, `name`.
  - Deterministic `id` format: `${provider}:${providerId}`.
  - Conflict target: `(provider, "providerId")` to avoid duplicate key errors; updates `userId/email/name` when exists.
- **Session**: Set `sid` cookie to the canonical `Users.id` returned from DB to satisfy FK constraints.

### Connectivity considerations
- Enable Node.js compat in `wrangler.jsonc`: `"compatibility_flags": ["nodejs_compat"]`.
- In dev, avoid `*.hyperdrive.local` CONNECT_TIMEOUT by falling back to `DATABASE_URL` when present.

## Auth Mocking Toggle
- **Decision**: Gate localhost mock behind `USE_MOCK_AUTH` env.
  - When `USE_MOCK_AUTH=true` and on `localhost`, Worker returns a mock user.
  - Default set to false to prefer real Google OAuth even locally.

## UI
- **Avatar**: Frontend displays the user avatar (`user.imageUrl`) when authenticated. Fallback: placeholder.

## Navigation & Pages
- **TopNavigation**: Center menu now includes `Home / Features / Contact`.
  - Home (`/`): Overview of the application and sign-in CTA.
  - Features (`/features`): Detailed description of capabilities for social presence management.
  - Contact (`/contact`): Contact form for prospective customers.
- **Account Menu**: Profile, Settings, and Log out moved to a dropdown under the user avatar/name.

## Legal Pages
- Added `Privacy Policy` page at route `/privacy-policy`.
- Added `Terms of Service` page at route `/terms-of-service`.

## Branding & Copy
- Renamed all visible references from "Modern Web Stack" to "Simple Social Thing".
- Home hero and footer copy rewritten to focus on value (scheduling, analytics, unified inbox).
- Browser title and meta description updated in `index.html`.

## UX Tweaks
- Account dropdown opens on hover, improved hover/focus highlight, and removed hover gap.
- Avatar/name links to `/dashboard`; caret toggles dropdown.
- Always show vertical scrollbar to avoid layout shift.
- Prevent hero H1 descender clipping.

## Routing
- SPA routing fixed for production: assets bound via `ASSETS` and Worker delegates non-API requests to assets.

## Performance
- Preconnected to Google Fonts and removed CSS @import; fonts loaded via `<link>` in `index.html`.

## Footer
- Reusable footer with links to `/privacy-policy` and `/terms-of-service`, included across primary marketing pages.

## Backend (Go API)
- **Architecture**: Go backend API with PostgreSQL for database operations.
- **Framework**: Gorilla Mux for routing, CORS enabled.
- **Development**: Air for hot reload during development.
- **Database**: PostgreSQL with golang-migrate for migrations.
- **Deployment**: Multi-environment (dev/staging/production) via Jenkins pipeline.
- **Port**: Development runs on `18911`.

### Project Structure
- `backend/cmd/api/` - Application entry point
- `backend/internal/handlers/` - HTTP request handlers
- `backend/internal/models/` - Data models
- `backend/db/migrations/` - SQL migration files
- `deploy/` - Jenkins pipeline and deployment scripts
- `deploy/systemd/` - Systemd service files for each environment

### Development
- Start: `make dev` (uses Air for hot reload)
- Stop: Press `Ctrl+C` — the server traps SIGINT/SIGTERM and shuts down gracefully within ~5s.
- Migrations: `make migrate-up` / `make migrate-down`
- Build: `make build`
- Test: `make test`

### Configuration
- No hardcoded database credentials in wrangler configs
- `.dev.vars` used for local development (gitignored)
- `CLOUDFLARE_HYPERDRIVE_LOCAL_CONNECTION_STRING_HYPERDRIVE` set from `DATABASE_URL` in package.json script
- Production uses Cloudflare Hyperdrive config (secure)

### Testing
- **Unit Tests**: Standard Go tests in `*_test.go` files
- **BDD Tests**: Behavior-Driven Development using Godog/Gherkin
  - Feature files in `backend/features/` directory
  - Step definitions in `backend/bdd_test.go`
  - Run with: `make -f Makefile.bdd bdd-test`
  - Comprehensive coverage of all API endpoints and features
  - See `backend/BDD_TESTING.md` for detailed documentation
