# Project Plan: simple-social-thing

## Current Goals
- Ensure Google OAuth works locally and in production (Cloudflare Workers).
- Run Vite (client) and Wrangler (worker) together via a single dev command.
- Avoid local port conflicts from the Cloudflare Vite plugin/Miniflare.

## Decisions
- Worker OAuth callback path: `/api/auth/google/callback`.
- Build `redirect_uri` dynamically in the Worker from `request.url.origin` to avoid hardcoding ports/domains.
- Frontend builds `redirect_uri` using `VITE_WORKER_ORIGIN` with fallback to `window.location.origin`.
- Use Google v2 authorize endpoint: `https://accounts.google.com/o/oauth2/v2/auth`.
- Disable `@cloudflare/vite-plugin` during `vite dev` to avoid Miniflare using port 9229; still allow enabling via env.

## Local Development
- Env file (`frontend/.env.local`):
  - `VITE_WORKER_ORIGIN=http://localhost:8787`
  - `VITE_DISABLE_CF_PLUGIN=1`
  - `VITE_GOOGLE_CLIENT_ID=<your-client-id>`
- Start dev servers: `npm run dev` from `frontend/`.
  - Client: http://localhost:5173
  - Worker: http://localhost:8787
- Authorized redirect URI in Google Console (dev):
  - `http://localhost:8787/api/auth/google/callback`

## Production (Cloudflare)
- Set Worker secrets:
  - `wrangler secret put GOOGLE_CLIENT_ID`
  - `wrangler secret put GOOGLE_CLIENT_SECRET`
- Authorized redirect URI in Google Console (prod):
  - `https://<your-worker-domain>/api/auth/google/callback` (e.g., workers.dev or custom domain via routes)
- Frontend config:
  - If same origin as Worker, omit `VITE_WORKER_ORIGIN` (fallback to `window.location.origin`).
  - If different origin, set `VITE_WORKER_ORIGIN=https://<your-worker-domain>`.
- Deploy: `npm run deploy` from `frontend/`.

## Next Up
- Add basic auth state handling in the client after redirect parameter `?oauth=...`.
- Add error handling UI for OAuth failures.
- Wire up API calls behind `/api/` in Worker.

## Database Integration (Xata)
- **Decision**: Use Xata REST API from the Worker for persistence (no generated types in Worker).
- **Users table**: Persist `id`, `email`, `name`, and `imageUrl` (added column) into `public.Users`.
- **SocialConnections**: Persist OAuth-provider links into `public.SocialConnections` with fields `id`, `userId`, `provider`, `providerId`, `email`, `name`.
  - Deterministic `id` format: `${provider}:${providerId}` to ensure idempotency across upserts.
- **Env**: Require `XATA_API_KEY` and `XATA_DATABASE_URL` in Worker env for local and prod.

## Auth Mocking Toggle
- **Decision**: Gate localhost mock behind `USE_MOCK_AUTH` env.
  - When `USE_MOCK_AUTH=true` and on `localhost`, Worker returns a mock user.
  - Default set to false to prefer real Google OAuth even locally.

## UI
- **Avatar**: Frontend displays the user avatar (`user.imageUrl`) when authenticated. Fallback: placeholder.

## Navigation & Pages
- **TopNavigation**: Center menu now includes `Home / Features / Contact`.
  - Home (`/`): Overview of the application and sign-in CTA.
  - Features (`/features`): Detailed description of capabilities for social presence management.
  - Contact (`/contact`): Contact form for prospective customers.
- **Account Menu**: Profile, Settings, and Log out moved to a dropdown under the user avatar/name.

